<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FLUXO DE ATENDIMENTO E VENDAS</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1722;
      --panel2:#111c2a;
      --text:#e9eef6;
      --muted:#9fb0c6;
      --line:#223246;
      --accent:#ffd400; /* ‚Äúamarelo GM vibes‚Äù */
      --ok:#27d17f;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 20% 0%, #182338 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 28px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,212,0,.10), rgba(255,212,0,.02));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .logo{
      width:52px;height:52px;border-radius:12px;
      display:grid;place-items:center;
      background:#05070a;
      border:1px solid rgba(255,212,0,.35);
      overflow:hidden;
      padding:4px;
    }
    .logo svg{width:100%;height:100%;display:block}
    .title{
      line-height:1.1;min-width:0;
    }
    .title h1{
      margin:0;font-size:18px;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .title .sub{
      margin-top:6px;font-size:12px;color:var(--muted);
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    button, .btn{
      appearance:none;border:1px solid var(--line);background: rgba(255,255,255,.04);
      color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;
      font-weight:600;transition:transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;align-items:center;gap:10px;
    }
    button:hover{background: rgba(255,255,255,.07);border-color:#2e435f}
    button:active{transform:translateY(1px)}
    .btnAccent{
      background: rgba(255,212,0,.16);
      border-color: rgba(255,212,0,.45);
    }
    .btnAccent:hover{
      background: rgba(255,212,0,.22);
      border-color: rgba(255,212,0,.60);
    }
    .btnSmall{padding:8px 10px;border-radius:10px;font-size:12px}
    .btnDanger{border-color: rgba(255,77,77,.45);background: rgba(255,77,77,.10)}
    .btnDanger:hover{background: rgba(255,77,77,.16);border-color: rgba(255,77,77,.60)}
    .grid{
      display:grid;grid-template-columns: 260px 1fr;gap:14px;margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .tabs{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tablist{
      display:flex;flex-direction:column;
    }
    .tab{
      padding:12px 12px;border:0;border-bottom:1px solid var(--line);background:transparent;
      color:var(--muted);text-align:left;cursor:pointer;font-weight:800;
      display:flex;align-items:center;gap:10px;
    }
    .tab:last-child{border-bottom:0}
    .tab[aria-selected="true"]{
      background: rgba(255,212,0,.10);
      color:var(--text);
    }
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px;border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .panelHeader h2{margin:0;font-size:16px}
    .panelHeader p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .panelBody{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--text);outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .fields{
      display:grid;grid-template-columns: repeat(4, 1fr);gap:10px;
    }
    @media (max-width: 980px){ .fields{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .fields{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:var(--radius2);
      padding:12px;
    }
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr;} }
    .kpi .v{font-size:22px;font-weight:900}
    .kpi .t{color:var(--muted);font-size:12px;margin-top:4px}

    table{
      width:100%;border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:14px;border:1px solid var(--line);
      background: rgba(0,0,0,.20);
    }
    th, td{padding:10px 10px;border-bottom:1px solid rgba(34,50,70,.65);font-size:13px}
    th{color:#d8e2f1;font-size:12px;text-transform:uppercase;letter-spacing:.7px;background: rgba(255,255,255,.04)}
    tr:last-child td{border-bottom:0}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 9px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);font-size:12px;color:var(--muted);
    }
    .badge strong{color:var(--text)}
    .split{
      display:grid;grid-template-columns:1.2fr .8fr;gap:10px;align-items:start;
    }
    @media (max-width:980px){.split{grid-template-columns:1fr}}

    /* Relat√≥rio di√°rio ‚Äúestilo planilha‚Äù */
    .reportWrap{
      display:grid;grid-template-columns: 1fr 240px;gap:12px;align-items:start;
    }
    @media (max-width:980px){.reportWrap{grid-template-columns:1fr}}
    .block{
      border:2px solid #e6eefc;
      background:#f7f9ff;
      color:#111;
      border-radius:10px;
      overflow:hidden;
    }
    .block .head{
      padding:10px 10px;
      font-weight:900;
      text-align:center;
      border-bottom:2px solid #111;
    }
    .head.yellow{background:#ffe600}
    .head.green{background:#89d46a}
    .head.blue{background:#b8c7ff}
    .block .subhead{
      padding:8px 10px;font-weight:900;text-align:center;border-bottom:2px solid #111;
      background:#fff;
    }
    .block table{border:0;border-radius:0;background:transparent}
    .block th, .block td{
      border-bottom:1px solid #222;
      padding:7px 8px;
      font-size:12px;
      color:#111;
      background:#fff;
    }
    .block th{background:#f2f2f2;color:#111}
    .block .totalRow td{font-weight:900;background:#f6f6f6}
    .totBox{
      border:2px solid #111;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
    }
    .totBox .tHead{
      padding:10px;font-weight:900;text-align:center;border-bottom:2px solid #111
    }
    .totBox .tHead.yellow{background:#ffe600}
    .totBox .tHead.green{background:#89d46a}
    .totBox .tHead.blue{background:#b8c7ff}
    .totBox .big{
      font-size:48px;font-weight:1000;text-align:center;padding:18px 0;
    }
    .miniSummary{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;
    }
    @media (max-width:980px){.miniSummary{grid-template-columns:1fr}}
    .mini{
      border:2px solid #111;border-radius:10px;overflow:hidden;background:#fff;color:#111;
    }
    .mini .mHead{padding:10px;font-weight:900;text-align:center;border-bottom:2px solid #111}
    .mini .mHead.yellow{background:#ffe600}
    .mini .mHead.green{background:#89d46a}
    .mini .mVal{font-size:40px;font-weight:1000;text-align:center;padding:14px 0}
    .mini .mFoot{padding:10px;text-align:center;border-top:2px solid #111;font-weight:900;background:#f3f3f3}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:14px;
      z-index:50;
    }
    .modal{
      width:min(820px, 100%);
      border:1px solid var(--line);
      background: #111c2a;
      border-radius:18px;box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal input, .modal select, .modal textarea{
      background:#0b131d;
      border-color:#32495f;
    }
    .modalHeader{
      padding:14px 14px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalHeader h3{margin:0;font-size:15px}
    .modalBody{padding:14px}
    .modalFooter{
      padding:14px;border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px}
    .linklike{
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dashed rgba(255,212,0,.5);
    }
    .linklike:hover{border-bottom-style:solid}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" title="Chevrolet / GM">
          <svg viewBox="0 0 64 32" aria-hidden="true">
            <defs>
              <linearGradient id="goldA" x1="0" x2="1">
                <stop offset="0" stop-color="#6f5313"/>
                <stop offset="0.18" stop-color="#e7cf84"/>
                <stop offset="0.5" stop-color="#c6a759"/>
                <stop offset="0.82" stop-color="#f5e2a6"/>
                <stop offset="1" stop-color="#82631d"/>
              </linearGradient>
            </defs>
            <path fill="url(#goldA)" stroke="#b9a271" stroke-width="1.5" d="M2 12h20l3-6h14v6h23v8H42l-3 6H25v-6H2z"/>
            <path fill="rgba(255,255,255,.35)" d="M4 13h20l3-6h10v2H26l-3 6H4z"/>
            <path fill="rgba(0,0,0,.28)" d="M2 20h23l3 6h11v-2H30l-3-6H2z"/>
          </svg>
        </div>
        <div class="title">
          <h1>FLUXO DE ATENDIMENTO E VENDAS</h1>
          <div class="sub">
            <span class="pill" id="pillStatus"><span class="dot warn" id="statusDot"></span><span id="statusText">carregando‚Ä¶</span></span>
            <span class="pill"><span class="muted">Atualiza√ß√£o:</span> <strong id="syncEvery">60s</strong></span>
            <span class="pill"><span class="muted">Registros:</span> <strong id="countAll">0</strong></span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btnSmall" id="btnSync" title="For√ßar atualiza√ß√£o agora">üîÑ Atualizar</button>
        <button class="btnSmall" id="btnExportDaily" title="Exportar relat√≥rio di√°rio como imagem (PNG)">üñºÔ∏è Exportar Relat√≥rio</button>
        <button class="btnAccent" id="btnAdd" title="Inserir novo atendimento">‚ûï</button>
      </div>
    </header>

    <div class="grid">
      <aside class="tabs" aria-label="Abas">
        <div class="tablist" role="tablist">
          <button class="tab" role="tab" aria-selected="true" data-tab="daily">üìã 1) Di√°rio + Ordem</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="monthly">üìÜ 2) Mensal</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="seller">üßë‚Äçüíº 3) Vendedor</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="car">üöó 4) Carro</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="settings">‚öôÔ∏è 5) Configura√ß√µes</button>
        </div>
      </aside>

      <main class="panel" id="mainPanel">
        <!-- DAILY -->
        <section class="tabPanel" id="tab-daily">
          <div class="panelHeader">
            <div>
              <h2>Relat√≥rio di√°rio e Ordem de Atendimento</h2>
              <p>Escolha a data, visualize o fluxo por tipo e m√≠dia, e mantenha a ordem de atendimento sequencial.</p>
            </div>
            <div class="row">
              <div style="min-width:220px">
                <label>Data do relat√≥rio</label>
                <input type="date" id="dailyDate" />
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btnSmall" id="btnCopyImg">üìã Copiar imagem</button>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btnSmall" id="btnDownloadImg">‚¨áÔ∏è Baixar PNG</button>
              </div>
            </div>
          </div>

          <div class="panelBody">
            <div class="split">
              <div class="card">
                <div class="row" style="justify-content:space-between">
                  <div class="badge">Ordem atual: <strong id="orderIndexLabel">‚Äî</strong></div>
                  <div class="row">
                    <button class="btnSmall" id="btnPrevSeller">‚¨ÖÔ∏è</button>
                    <button class="btnSmall" id="btnNextSeller">‚û°Ô∏è Pr√≥ximo atendimento</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div class="row" style="justify-content:space-between;align-items:flex-start">
                  <div style="flex:1;min-width:220px">
                    <div class="muted small" style="margin-bottom:6px">Vendedor da vez</div>
                    <div style="font-size:28px;font-weight:1000" id="sellerNow">‚Äî</div>
                    <div class="hint">Clique em ‚ÄúPr√≥ximo atendimento‚Äù quando chegar um cliente novo na loja, pra rodar sequencialmente (sem bagun√ßa aleat√≥ria).</div>
                  </div>
                  <div style="flex:1;min-width:220px">
                    <div class="muted small" style="margin-bottom:6px">Fila completa</div>
                    <div id="orderList" class="mono" style="white-space:pre-wrap;font-size:12px;line-height:1.45;color:#d8e2f1"></div>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="muted small">Vendas do dia (manual) ‚Üí para calcular % vendas x fluxo</div>
                <div class="fields" style="margin-top:10px;grid-template-columns:repeat(3,1fr)">
                  <div>
                    <label>Vendas NOVOS</label>
                    <input type="number" min="0" step="1" id="salesNovos" />
                  </div>
                  <div>
                    <label>Vendas SEMINOVOS</label>
                    <input type="number" min="0" step="1" id="salesSemis" />
                  </div>
                  <div>
                    <label>Vendas VD</label>
                    <input type="number" min="0" step="1" id="salesVD" />
                  </div>
                </div>
                <div class="hint">Seu formul√°rio n√£o tem ‚Äúfechou venda?‚Äù, ent√£o o fluxo vem dos atendimentos. Essas 3 caixinhas s√£o pra voc√™ lan√ßar as vendas fechadas do dia e manter o padr√£o do relat√≥rio.</div>
              </div>
            </div>

            <div class="hr"></div>

            <!-- RELAT√ìRIO VISUAL (DOM) -->
            <div id="dailyReportDom">
              <div class="reportWrap">
                <div>
                  <div class="block">
                    <div class="head yellow">VENDAS / FLUXO</div>
                    <div class="subhead">NOVOS</div>
                    <div style="padding:10px">
                      <table id="tblNovos"></table>
                    </div>
                  </div>

                  <div style="height:12px"></div>

                  <div class="block">
                    <div class="head green">SEMINOVOS</div>
                    <div style="padding:10px">
                      <table id="tblSemis"></table>
                    </div>
                  </div>

                  <div style="height:12px"></div>

                  <div class="block">
                    <div class="head blue">VD</div>
                    <div style="padding:10px">
                      <table id="tblVD"></table>
                    </div>
                  </div>

                  <div class="miniSummary" style="margin-top:12px">
                    <div class="mini">
                      <div class="mHead yellow">VENDAS / DIA<br/>NOVOS</div>
                      <div class="mVal" id="kSalesNovos">0</div>
                      <div class="mFoot">FLUXO DIA: <span id="kFluxNovos">0</span> ¬∑ <span id="kConvNovos">0%</span></div>
                    </div>
                    <div class="mini">
                      <div class="mHead green">VENDAS / DIA<br/>SEMINOVOS</div>
                      <div class="mVal" id="kSalesSemis">0</div>
                      <div class="mFoot">FLUXO DIA: <span id="kFluxSemis">0</span> ¬∑ <span id="kConvSemis">0%</span></div>
                    </div>
                    <div class="mini">
                      <div class="mHead" style="background:#b8c7ff">VENDAS / DIA<br/>VD</div>
                      <div class="mVal" id="kSalesVD">0</div>
                      <div class="mFoot">FLUXO DIA: <span id="kFluxVD">0</span> ¬∑ <span id="kConvVD">0%</span></div>
                    </div>
                  </div>
                </div>

                <div>
                  <div class="totBox">
                    <div class="tHead yellow">TOTAL DE FLUXO<br/>NOVOS</div>
                    <div class="big" id="totNovos">0</div>
                  </div>
                  <div style="height:12px"></div>
                  <div class="totBox">
                    <div class="tHead green">TOTAL DE FLUXO<br/>SEMINOVOS</div>
                    <div class="big" id="totSemis">0</div>
                  </div>
                  <div style="height:12px"></div>
                  <div class="totBox">
                    <div class="tHead blue">TOTAL DE FLUXO<br/>VD</div>
                    <div class="big" id="totVD">0</div>
                  </div>

                  <div class="hint" style="margin-top:10px;color:#d1d9e7">
                    Exporta√ß√£o: o bot√£o ‚ÄúExportar Relat√≥rio‚Äù gera um PNG padronizado do relat√≥rio di√°rio (via canvas) ‚Äî ideal pra enviar no fim do expediente.
                  </div>
                </div>
              </div>
            </div>

            <canvas id="exportCanvas" style="display:none"></canvas>
          </div>
        </section>

        <!-- MONTHLY -->
        <section class="tabPanel" id="tab-monthly" style="display:none">
          <div class="panelHeader">
            <div>
              <h2>Aba mensal</h2>
              <p>Selecione o m√™s e veja todos os registros inseridos, com resumo de volume.</p>
            </div>
            <div class="row">
              <div style="min-width:220px">
                <label>M√™s</label>
                <input type="month" id="monthPick" />
              </div>
            </div>
          </div>
          <div class="panelBody">
            <div class="kpis">
              <div class="card kpi"><div class="v" id="mTotal">0</div><div class="t">Atendimentos no m√™s</div></div>
              <div class="card kpi"><div class="v" id="mNovos">0</div><div class="t">NOVOS</div></div>
              <div class="card kpi"><div class="v" id="mSemis">0</div><div class="t">SEMINOVOS</div></div>
              <div class="card kpi"><div class="v" id="mVD">0</div><div class="t">VD</div></div>
            </div>
            <div class="hr"></div>
            <div class="card">
              <div class="row" style="justify-content:space-between">
                <div class="badge">Tabela do m√™s</div>
                <div class="muted small">Dica: a busca/filtro por vendedor/carro t√° nas abas espec√≠ficas.</div>
              </div>
              <div style="margin-top:10px;overflow:auto">
                <table id="tblMonth"></table>
              </div>
            </div>
          </div>
        </section>

        <!-- SELLER -->
        <section class="tabPanel" id="tab-seller" style="display:none">
          <div class="panelHeader">
            <div>
              <h2>Aba do vendedor</h2>
              <p>Selecione um vendedor para ver a rela√ß√£o de clientes (portf√≥lio) e hist√≥rico.</p>
            </div>
            <div class="row">
              <div style="min-width:260px">
                <label>Vendedor</label>
                <select id="sellerPick"></select>
              </div>
            </div>
          </div>
          <div class="panelBody">
            <div class="kpis">
              <div class="card kpi"><div class="v" id="sTotal">0</div><div class="t">Atendimentos (total)</div></div>
              <div class="card kpi"><div class="v" id="sClients">0</div><div class="t">Clientes √∫nicos</div></div>
              <div class="card kpi"><div class="v" id="sCars">0</div><div class="t">Carros √∫nicos</div></div>
              <div class="card kpi"><div class="v" id="sLast">‚Äî</div><div class="t">√öltimo atendimento</div></div>
            </div>
            <div class="hr"></div>
            <div class="card">
              <div class="badge">Portf√≥lio (clientes)</div>
              <div style="margin-top:10px;overflow:auto">
                <table id="tblSellerClients"></table>
              </div>
            </div>
          </div>
        </section>

        <!-- CAR -->
        <section class="tabPanel" id="tab-car" style="display:none">
          <div class="panelHeader">
            <div>
              <h2>Aba do carro</h2>
              <p>Selecione um carro e veja a rela√ß√£o ‚Äúcarro ‚Üí vendedores ‚Üí clientes‚Äù.</p>
            </div>
            <div class="row">
              <div style="min-width:320px">
                <label>Carro</label>
                <select id="carPick"></select>
              </div>
            </div>
          </div>
          <div class="panelBody">
            <div class="kpis">
              <div class="card kpi"><div class="v" id="cTotal">0</div><div class="t">Atendimentos (total)</div></div>
              <div class="card kpi"><div class="v" id="cSellers">0</div><div class="t">Vendedores</div></div>
              <div class="card kpi"><div class="v" id="cClients">0</div><div class="t">Clientes √∫nicos</div></div>
              <div class="card kpi"><div class="v" id="cLast">‚Äî</div><div class="t">√öltimo atendimento</div></div>
            </div>
            <div class="hr"></div>
            <div class="card">
              <div class="badge">Rela√ß√£o por vendedor</div>
              <div style="margin-top:10px;overflow:auto">
                <table id="tblCarMap"></table>
              </div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="tabPanel" id="tab-settings" style="display:none">
          <div class="panelHeader">
            <div>
              <h2>Configura√ß√µes</h2>
              <p>Vendedores, ordem de atendimento e status da sincroniza√ß√£o (dados ficam salvos local + planilha).</p>
            </div>
          </div>
          <div class="panelBody">
            <div class="fields">
              <div>
                <label>URL do Apps Script (WebApp)</label>
                <input id="cfgUrl" />
                <div class="hint">Ex.: https://script.google.com/macros/s/XXXX/exec</div>
              </div>
              <div>
                <label>Intervalo de atualiza√ß√£o (segundos)</label>
                <input type="number" min="15" step="5" id="cfgInterval" />
                <div class="hint">Padr√£o: 60s (minuto a minuto).</div>
              </div>
              <div>
                <label>Nome da loja / observa√ß√£o (opcional)</label>
                <input id="cfgStore" placeholder="Ex.: GM BH - Loja X" />
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btnAccent" id="btnSaveCfg">üíæ Salvar configura√ß√µes</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="split">
              <div class="card">
                <div class="row" style="justify-content:space-between">
                  <div class="badge">Vendedores (1 por linha)</div>
                  <div class="row">
                    <button class="btnSmall" id="btnApplyVendors">‚úÖ Aplicar</button>
                    <button class="btnSmall btnDanger" id="btnResetVendors">üß® Reset</button>
                  </div>
                </div>
                <textarea id="cfgVendors" spellcheck="false" class="mono" placeholder="Ex:\nLUCIANO\nMOTTA\nRANNDARA"></textarea>
                <div class="hint">Esses nomes alimentam a ordem de atendimento e os filtros por vendedor.</div>
              </div>

              <div class="card">
                <div class="row" style="justify-content:space-between">
                  <div class="badge">Ordem de atendimento</div>
                  <div class="row">
                    <button class="btnSmall" id="btnShuffle">üé≤ Embaralhar</button>
                    <button class="btnSmall" id="btnSetOrder">‚úÖ Definir ordem</button>
                  </div>
                </div>
                <textarea id="cfgOrder" spellcheck="false" class="mono" placeholder="Se vazio, usa a mesma lista de vendedores."></textarea>
                <div class="hint">A ordem √© sequencial. O bot√£o ‚ÄúPr√≥ximo atendimento‚Äù avan√ßa 1 posi√ß√£o e salva o √≠ndice atual.</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="row" style="justify-content:space-between">
                <div class="badge">Status do site / dados</div>
                <div class="row">
                  <button class="btnSmall" id="btnClearCache">üßΩ Limpar cache local</button>
                  <button class="btnSmall" id="btnHealth">ü©∫ Testar conex√£o</button>
                </div>
              </div>
              <div class="hint" id="statusDetails" style="margin-top:10px"></div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAL: ADD RECORD -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <h3>Inserir atendimento</h3>
        <button class="btnSmall" id="btnCloseModal">‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="fields">
          <div>
            <label>Data</label>
            <input type="date" id="fDate" />
          </div>
          <div>
            <label>Hor√°rio</label>
            <input type="time" id="fTime" />
          </div>
          <div>
            <label>Vendedor</label>
            <select id="fSeller"></select>
          </div>
          <div>
            <label>M√≠dia</label>
            <select id="fMedia">
              <option>Passante</option>
              <option>Procura</option>
              <option>Telefone</option>
            </select>
          </div>

          <div style="grid-column: span 2">
            <label>Cliente</label>
            <input id="fClient" placeholder="Nome do cliente" />
          </div>
          <div style="grid-column: span 2">
            <label>Telefone do Cliente</label>
            <input id="fClientPhone" placeholder="DDD + n√∫mero" />
          </div>

          <div style="grid-column: span 2">
            <label>Carro</label>
            <input id="fCar" placeholder="Ex.: Onix LT 1.0 / Tracker Premier" />
          </div>
          <div style="grid-column: span 2">
            <label>Tipo de Venda</label>
            <select id="fType">
              <option>Vendas</option>
              <option>Seminovos</option>
              <option>Venda Direta</option>
            </select>
          </div>
        </div>

        <div class="hint">Ao salvar, o registro vai para a planilha (WebApp) e tamb√©m fica em cache local para leitura r√°pida.</div>
      </div>
      <div class="modalFooter">
        <button id="btnSave" class="btnAccent">üíæ Salvar</button>
        <button id="btnCancel" class="btnSmall">Cancelar</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   FLUXO GM ‚Äî HTML √öNICO
   Sem depend√™ncias externas
   =========================== */

const LS_KEY = "fluxo_gm_v1";
const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyD2TI1qmkBryQngjZ0eXb9dBnba5L5XS0zwxlBkfx2PccrLMbdOCmQY7UoxEg36nYo/exec";
const DEFAULTS = {
  webappUrl: DEFAULT_WEBAPP_URL,
  intervalSec: 60,
  storeName: "",
  vendors: ["LUCIANO", "MOTTA", "RANNDARA"],
  order: ["LUCIANO", "MOTTA", "RANNDARA"],
  orderIndex: 0,
  cachedRows: [],
  cachedAt: 0,
  salesByDate: {} // { "YYYY-MM-DD": {novos:0, semis:0, vd:0} }
};

let state = loadState();
let timer = null;
let lastSyncOk = false;

/* ---------- DOM refs ---------- */
const $ = (id) => document.getElementById(id);

const statusDot = $("statusDot");
const statusText = $("statusText");
const countAll = $("countAll");
const syncEvery = $("syncEvery");
const statusDetails = $("statusDetails");

const tabs = document.querySelectorAll(".tab");
const tabPanels = {
  daily: $("tab-daily"),
  monthly: $("tab-monthly"),
  seller: $("tab-seller"),
  car: $("tab-car"),
  settings: $("tab-settings"),
};

const dailyDate = $("dailyDate");
const salesNovos = $("salesNovos");
const salesSemis = $("salesSemis");
const salesVD = $("salesVD");

const sellerNow = $("sellerNow");
const orderList = $("orderList");
const orderIndexLabel = $("orderIndexLabel");

const tblNovos = $("tblNovos");
const tblSemis = $("tblSemis");
const tblVD = $("tblVD");

const totNovos = $("totNovos");
const totSemis = $("totSemis");
const totVD = $("totVD");

const kSalesNovos = $("kSalesNovos");
const kSalesSemis = $("kSalesSemis");
const kSalesVD = $("kSalesVD");
const kFluxNovos = $("kFluxNovos");
const kFluxSemis = $("kFluxSemis");
const kFluxVD = $("kFluxVD");
const kConvNovos = $("kConvNovos");
const kConvSemis = $("kConvSemis");
const kConvVD = $("kConvVD");

const monthPick = $("monthPick");
const tblMonth = $("tblMonth");
const mTotal = $("mTotal");
const mNovos = $("mNovos");
const mSemis = $("mSemis");
const mVD = $("mVD");

const sellerPick = $("sellerPick");
const tblSellerClients = $("tblSellerClients");
const sTotal = $("sTotal");
const sClients = $("sClients");
const sCars = $("sCars");
const sLast = $("sLast");

const carPick = $("carPick");
const tblCarMap = $("tblCarMap");
const cTotal = $("cTotal");
const cSellers = $("cSellers");
const cClients = $("cClients");
const cLast = $("cLast");

/* settings */
const cfgUrl = $("cfgUrl");
const cfgInterval = $("cfgInterval");
const cfgStore = $("cfgStore");
const cfgVendors = $("cfgVendors");
const cfgOrder = $("cfgOrder");

/* modal */
const modalBack = $("modalBack");
const fDate = $("fDate");
const fTime = $("fTime");
const fSeller = $("fSeller");
const fMedia = $("fMedia");
const fClient = $("fClient");
const fClientPhone = $("fClientPhone");
const fCar = $("fCar");
const fType = $("fType");

/* export */
const exportCanvas = $("exportCanvas");

/* ---------- init ---------- */
boot();

function boot(){
  // defaults date
  const today = new Date();
  dailyDate.value = toISODate(today);
  monthPick.value = toISOMonth(today);

  // wire tabs
  tabs.forEach(t => t.addEventListener("click", () => switchTab(t.dataset.tab)));

  // buttons
  $("btnAdd").addEventListener("click", openModal);
  $("btnCloseModal").addEventListener("click", closeModal);
  $("btnCancel").addEventListener("click", closeModal);
  $("btnSave").addEventListener("click", saveRecord);

  $("btnSync").addEventListener("click", () => syncNow(true));
  $("btnHealth").addEventListener("click", healthCheck);

  $("btnPrevSeller").addEventListener("click", prevSeller);
  $("btnNextSeller").addEventListener("click", nextSeller);

  $("btnExportDaily").addEventListener("click", () => exportDaily("download"));
  $("btnDownloadImg").addEventListener("click", () => exportDaily("download"));
  $("btnCopyImg").addEventListener("click", () => exportDaily("copy"));

  $("btnSaveCfg").addEventListener("click", saveSettings);
  $("btnApplyVendors").addEventListener("click", applyVendors);
  $("btnResetVendors").addEventListener("click", resetVendors);
  $("btnShuffle").addEventListener("click", shuffleOrder);
  $("btnSetOrder").addEventListener("click", setOrderFromTextarea);
  $("btnClearCache").addEventListener("click", clearCache);

  dailyDate.addEventListener("change", () => { renderAll(); });
  monthPick.addEventListener("change", () => { renderAll(); });
  sellerPick.addEventListener("change", () => { renderAll(); });
  carPick.addEventListener("change", () => { renderAll(); });

  salesNovos.addEventListener("input", saveSalesForDay);
  salesSemis.addEventListener("input", saveSalesForDay);
  salesVD.addEventListener("input", saveSalesForDay);

  // fill settings UI
  cfgUrl.value = state.webappUrl;
  cfgInterval.value = state.intervalSec;
  cfgStore.value = state.storeName || "";
  cfgVendors.value = state.vendors.join("\n");
  cfgOrder.value = state.order.join("\n");

  // fill seller dropdowns
  refreshVendorsUI();

  // restore sales inputs
  loadSalesForDay();

  // show order
  renderOrder();

  // initial render from cache then sync
  renderAll();
  syncNow(false);

  // conectividade do navegador
  window.addEventListener("online", () => syncNow(true));
  window.addEventListener("offline", () => {
    setStatus("bad", "offline (sem internet)", "‚ö†Ô∏è Sem internet no navegador. O sistema continua em cache local.");
  });

  // schedule
  reschedule();
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULTS);
    const parsed = JSON.parse(raw);
    const loaded = {
      ...structuredClone(DEFAULTS),
      ...parsed,
      vendors: Array.isArray(parsed.vendors) && parsed.vendors.length ? parsed.vendors : structuredClone(DEFAULTS.vendors),
      order: Array.isArray(parsed.order) && parsed.order.length ? parsed.order : structuredClone(DEFAULTS.order),
      cachedRows: Array.isArray(parsed.cachedRows) ? parsed.cachedRows : [],
      salesByDate: parsed.salesByDate || {}
    };
    loaded.webappUrl = String(loaded.webappUrl || "").trim() || DEFAULT_WEBAPP_URL;
    return loaded;
  }catch(e){
    return structuredClone(DEFAULTS);
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

function reschedule(){
  if(timer) clearInterval(timer);
  const sec = clampInt(state.intervalSec, 15, 3600);
  state.intervalSec = sec;
  saveState();
  syncEvery.textContent = `${sec}s`;
  timer = setInterval(() => syncNow(false), sec*1000);
}

function setStatus(kind, msg, details){
  statusText.textContent = msg;
  statusDot.classList.remove("ok","warn","bad");
  statusDot.classList.add(kind);
  if(details){
    statusDetails.innerHTML = details;
  }
}

function resolveWebAppUrl(raw){
  const value = String(raw || "").trim() || DEFAULT_WEBAPP_URL;
  let url = null;
  try{
    url = new URL(value);
  }catch(_){
    throw new Error("URL do WebApp inv√°lida. Revise em Configura√ß√µes.");
  }
  if(!/^https?:$/.test(url.protocol)){
    throw new Error("URL do WebApp deve come√ßar com http:// ou https://.");
  }
  return url;
}

function switchTab(name){
  tabs.forEach(t => t.setAttribute("aria-selected", String(t.dataset.tab===name)));
  Object.keys(tabPanels).forEach(k => tabPanels[k].style.display = (k===name) ? "block" : "none");
}

/* ---------- order rotation ---------- */
function renderOrder(){
  const list = state.order && state.order.length ? state.order : state.vendors;
  if(!list.length){
    sellerNow.textContent = "‚Äî";
    orderIndexLabel.textContent = "0/0";
    orderList.textContent = "(sem vendedores)";
    return;
  }
  state.order = list;
  state.orderIndex = clampInt(state.orderIndex, 0, list.length-1);
  saveState();

  sellerNow.textContent = list[state.orderIndex];
  orderIndexLabel.textContent = `${state.orderIndex+1}/${list.length}`;
  orderList.textContent = list.map((v,i)=> `${i===state.orderIndex ? "üëâ" : "  "} ${String(i+1).padStart(2,"0")} - ${v}`).join("\n");
}
function nextSeller(){
  if(!state.order.length) return;
  state.orderIndex = (state.orderIndex + 1) % state.order.length;
  saveState();
  renderOrder();
}
function prevSeller(){
  if(!state.order.length) return;
  state.orderIndex = (state.orderIndex - 1 + state.order.length) % state.order.length;
  saveState();
  renderOrder();
}

/* ---------- modal ---------- */
function openModal(){
  const now = new Date();
  fDate.value = toISODate(now);
  fTime.value = toTime(now);
  fillSelect(fSeller, state.vendors, state.order[state.orderIndex] || state.vendors[0] || "");
  modalBack.style.display = "flex";
  modalBack.setAttribute("aria-hidden", "false");
  // foco
  setTimeout(()=> fClient.focus(), 50);
}
function closeModal(){
  modalBack.style.display = "none";
  modalBack.setAttribute("aria-hidden", "true");
  fClient.value = "";
  fClientPhone.value = "";
  fCar.value = "";
}

/* ---------- data sync ---------- */
async function healthCheck(){
  try{
    setStatus("warn", "testando conex√£o‚Ä¶");
    const url = resolveWebAppUrl(state.webappUrl);
    url.searchParams.set("action","health");
    const r = await fetch(url.toString(), { method:"GET" });
    const j = await r.json();
    if(j.ok){
      setStatus("ok", "conectado", `‚úÖ WebApp respondeu. <span class="mono small">${escapeHtml(url.toString())}</span>`);
    }else{
      setStatus("bad", "falha no health", `<span class="mono small">${escapeHtml(JSON.stringify(j))}</span>`);
    }
  }catch(e){
    setStatus("bad", "sem conex√£o", `Erro: <span class="mono small">${escapeHtml(String(e))}</span>`);
  }
}

async function syncNow(force){
  // evita spam se acabou de sincronizar com sucesso (a menos que force)
  if(!force && lastSyncOk && Date.now() - state.cachedAt < Math.max(5000, state.intervalSec*700)) return;

  try{
    setStatus("warn", "sincronizando‚Ä¶");
    const url = resolveWebAppUrl(state.webappUrl);
    url.searchParams.set("action","list");
    url.searchParams.set("limit","3000"); // ajuste se precisar mais
    // (filtros por data poderiam vir aqui, mas como seu script pode n√£o ter, filtramos local)
    const r = await fetch(url.toString(), { method:"GET" });
    const j = await r.json();

    if(!j.ok){
      lastSyncOk = false;
      setStatus("bad", "erro ao listar", `<span class="mono small">${escapeHtml(JSON.stringify(j))}</span>`);
      return;
    }

    // normaliza linhas
    const rows = Array.isArray(j.rows) ? j.rows.map(normalizeRow) : [];
    state.cachedRows = rows;
    state.cachedAt = Date.now();
    saveState();

    lastSyncOk = true;
    setStatus("ok", "atualizado", `‚úÖ √öltima atualiza√ß√£o: <strong>${new Date(state.cachedAt).toLocaleString("pt-BR")}</strong><br/>
      Fonte: <a class="linklike" href="${escapeAttr(state.webappUrl)}" target="_blank" rel="noreferrer">WebApp</a> ¬∑ Cache local ativo.`);
    renderAll();

  }catch(e){
    lastSyncOk = false;
    // mant√©m cache e avisa
    const isOnline = navigator.onLine;
    const kind = isOnline ? "warn" : "bad";
    const msg = isOnline ? "online (falha de sincroniza√ß√£o)" : "offline (usando cache)";
    setStatus(kind, msg, `‚ö†Ô∏è N√£o consegui atualizar agora. Mostrando dados do cache local.<br/>Erro: <span class="mono small">${escapeHtml(String(e))}</span>`);
    renderAll();
  }
}

/* ---------- insert record ---------- */
async function saveRecord(){
  const rec = {
    "Data": fromISOToBR(fDate.value), // salva DD/MM/AAAA (mant√©m padr√£o humano)
    "Vendedor": fSeller.value.trim(),
    "Cliente": fClient.value.trim(),
    "Carro": fCar.value.trim(),
    "Tipo de Venda": fType.value.trim(),
    "M√≠dia": fMedia.value.trim(),
    "Hor√°rio": fTime.value.trim(),
    "Telefone do Cliente": fClientPhone.value.trim()
  };

  // valida√ß√£o b√°sica
  const missing = [];
  if(!rec["Data"]) missing.push("Data");
  if(!rec["Vendedor"]) missing.push("Vendedor");
  if(!rec["Cliente"]) missing.push("Cliente");
  if(!rec["Tipo de Venda"]) missing.push("Tipo de Venda");
  if(!rec["M√≠dia"]) missing.push("M√≠dia");

  if(missing.length){
    alert("Preencha: " + missing.join(", "));
    return;
  }

  try{
    $("btnSave").disabled = true;
    $("btnSave").textContent = "Salvando‚Ä¶";

    const webappUrl = resolveWebAppUrl(state.webappUrl).toString();

    // Alguns WebApps do Google falham com preflight/CORS ao receber JSON puro.
    // Tentamos formatos compat√≠veis em sequ√™ncia, incluindo no-cors.
    const payload = JSON.stringify({ action:"add", record: rec });
    const attempts = [
      () => fetch(webappUrl, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: payload
      }),
      () => fetch(webappUrl, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ action:"add", payload }).toString()
      }),
      // fallback final: garante envio mesmo quando o navegador bloqueia leitura da resposta (opaque)
      () => fetch(webappUrl, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: payload
      }),
    ];

    let j = null;
    let lastErr = null;
    let sentWithNoCors = false;
    for(const run of attempts){
      try{
        const r = await run();
        if(r.type === "opaque"){
          sentWithNoCors = true;
          break;
        }
        const raw = await r.text();
        try{ j = JSON.parse(raw); }catch(_){ j = null; }
        if(!r.ok){
          throw new Error(`HTTP ${r.status} ${r.statusText}`);
        }
        if(j && j.ok) break;
        throw new Error(j ? JSON.stringify(j) : `Resposta inv√°lida do servidor: ${raw.slice(0,220)}`);
      }catch(err){
        lastErr = err;
        j = null;
      }
    }

    if(!sentWithNoCors && (!j || !j.ok)){
      throw (lastErr || new Error("N√£o foi poss√≠vel salvar no WebApp."));
    }

    // Atualiza cache local ‚Äúinstant√¢neo‚Äù
    state.cachedRows.unshift(normalizeRow(rec));
    state.cachedAt = Date.now();
    saveState();

    closeModal();
    if(sentWithNoCors){
      setStatus("warn", "registro enviado (no-cors)", `‚ö†Ô∏è Envio feito com <span class="mono small">no-cors</span>. O navegador n√£o permite ler a resposta, mas o dado foi enviado e salvo em cache local. Atualize em alguns segundos para confirmar na planilha.`);
      setTimeout(() => syncNow(true), 1800);
    }else{
      setStatus("ok", "registro inserido", `‚úÖ Atendimento salvo na planilha e em cache local. <strong>${new Date(state.cachedAt).toLocaleString("pt-BR")}</strong>`);
    }
    renderAll();

    // opcional: avan√ßar vendedor da vez automaticamente
    // nextSeller();

  }catch(e){
    setStatus("bad", "falha ao inserir", `Erro: <span class="mono small">${escapeHtml(String(e))}</span><br/>Dica: publique o WebApp como 'Qualquer pessoa', permita <span class="mono small">doPost(e)</span> e trate JSON + URL encoded.`);
    alert("Falha ao salvar. Veja o status no topo.");
  }finally{
    $("btnSave").disabled = false;
    $("btnSave").textContent = "üíæ Salvar";
  }
}

/* ---------- render ---------- */
function renderAll(){
  const rows = state.cachedRows || [];
  countAll.textContent = String(rows.length);

  // refresh dropdowns lists based on records too
  refreshPickersFromData(rows);

  renderDaily(rows);
  renderMonthly(rows);
  renderSeller(rows);
  renderCar(rows);
}

function renderDaily(rows){
  const iso = dailyDate.value || toISODate(new Date());
  const dayRows = rows.filter(r => r._dateISO === iso);

  // totals for day by tipo
  const byTipo = groupBy(dayRows, r => canonicalTipo(r.tipoVenda));
  const tipos = {
    "Vendas": byTipo.get("Vendas") || [],
    "Seminovos": byTipo.get("Seminovos") || [],
    "Venda Direta": byTipo.get("Venda Direta") || []
  };

  const vendors = state.vendors.slice();
  renderMatrixTable(tblNovos, vendors, tipos["Vendas"]);
  renderMatrixTable(tblSemis, vendors, tipos["Seminovos"]);
  renderMatrixTable(tblVD, vendors, tipos["Venda Direta"]);

  totNovos.textContent = String(tipos["Vendas"].length);
  totSemis.textContent = String(tipos["Seminovos"].length);
  totVD.textContent = String(tipos["Venda Direta"].length);

  // manual sales for conversions
  loadSalesForDay(); // keep inputs in sync when date changes
  const s = getSales(iso);
  const fluxNov = tipos["Vendas"].length;
  const fluxSem = tipos["Seminovos"].length;
  const fluxVDv = tipos["Venda Direta"].length;

  kSalesNovos.textContent = String(s.novos);
  kSalesSemis.textContent = String(s.semis);
  kSalesVD.textContent = String(s.vd);

  kFluxNovos.textContent = String(fluxNov);
  kFluxSemis.textContent = String(fluxSem);
  kFluxVD.textContent = String(fluxVDv);

  kConvNovos.textContent = pct(s.novos, fluxNov);
  kConvSemis.textContent = pct(s.semis, fluxSem);
  kConvVD.textContent = pct(s.vd, fluxVDv);
}

function renderMonthly(rows){
  const ym = monthPick.value || toISOMonth(new Date());
  const monthRows = rows.filter(r => r._dateISO && r._dateISO.startsWith(ym));
  mTotal.textContent = String(monthRows.length);

  const cNov = monthRows.filter(r => canonicalTipo(r.tipoVenda)==="Vendas").length;
  const cSem = monthRows.filter(r => canonicalTipo(r.tipoVenda)==="Seminovos").length;
  const cVDv = monthRows.filter(r => canonicalTipo(r.tipoVenda)==="Venda Direta").length;
  mNovos.textContent = String(cNov);
  mSemis.textContent = String(cSem);
  mVD.textContent = String(cVDv);

  renderTable(tblMonth, monthRows, [
    ["Data","dataBR"],
    ["Hor√°rio","hora"],
    ["Vendedor","vendedor"],
    ["Cliente","cliente"],
    ["Carro","carro"],
    ["Tipo","tipoVenda"],
    ["M√≠dia","midia"],
    ["Telefone","telCliente"]
  ]);
}

function renderSeller(rows){
  const vendor = sellerPick.value || (state.vendors[0] || "");
  const vRows = rows.filter(r => r.vendedor === vendor);

  sTotal.textContent = String(vRows.length);

  const clientsSet = new Set(vRows.map(r => (r.cliente||"").trim()).filter(Boolean));
  const carsSet = new Set(vRows.map(r => (r.carro||"").trim()).filter(Boolean));
  sClients.textContent = String(clientsSet.size);
  sCars.textContent = String(carsSet.size);

  const last = vRows.slice().sort((a,b)=> (b._ts||0)-(a._ts||0))[0];
  sLast.textContent = last ? `${last.dataBR} ${last.hora||""}`.trim() : "‚Äî";

  // portfolio table: one row per client (last car, last date, count)
  const map = new Map();
  for(const r of vRows){
    const key = (r.cliente||"").trim() || "(sem nome)";
    const cur = map.get(key) || {cliente:key, count:0, lastTS:0, lastDate:"", lastTime:"", lastCar:"", phones:new Set(), cars:new Set()};
    cur.count++;
    if(r.telCliente) cur.phones.add(r.telCliente);
    if(r.carro) cur.cars.add(r.carro);
    const ts = r._ts || 0;
    if(ts >= cur.lastTS){
      cur.lastTS = ts;
      cur.lastDate = r.dataBR;
      cur.lastTime = r.hora;
      cur.lastCar = r.carro;
    }
    map.set(key, cur);
  }
  const list = Array.from(map.values())
    .sort((a,b)=> b.lastTS - a.lastTS);

  renderTable(tblSellerClients, list, [
    ["Cliente","cliente"],
    ["Qtd","count","right"],
    ["√öltimo","_last",""],
    ["Carro (√∫ltimo)","lastCar"],
    ["Carros (√∫nicos)","_cars"],
    ["Telefone(s)","_phones"]
  ], (row)=>({
    ...row,
    _last: `${row.lastDate} ${row.lastTime||""}`.trim(),
    _phones: Array.from(row.phones).join(" / "),
    _cars: String(row.cars.size)
  }));
}

function renderCar(rows){
  const car = carPick.value || "";
  const cRows = rows.filter(r => (r.carro||"") === car);

  cTotal.textContent = String(cRows.length);
  const sellersSet = new Set(cRows.map(r => r.vendedor).filter(Boolean));
  const clientsSet = new Set(cRows.map(r => (r.cliente||"").trim()).filter(Boolean));
  cSellers.textContent = String(sellersSet.size);
  cClients.textContent = String(clientsSet.size);

  const last = cRows.slice().sort((a,b)=> (b._ts||0)-(a._ts||0))[0];
  cLast.textContent = last ? `${last.dataBR} ${last.hora||""}`.trim() : "‚Äî";

  // map by seller
  const map = new Map();
  for(const r of cRows){
    const key = r.vendedor || "(sem vendedor)";
    const cur = map.get(key) || { vendedor:key, count:0, clients:new Set(), lastTS:0, lastDate:"", lastTime:"" };
    cur.count++;
    if(r.cliente) cur.clients.add(r.cliente);
    const ts = r._ts || 0;
    if(ts >= cur.lastTS){
      cur.lastTS = ts;
      cur.lastDate = r.dataBR;
      cur.lastTime = r.hora;
    }
    map.set(key, cur);
  }
  const list = Array.from(map.values()).sort((a,b)=> b.count-a.count);

  renderTable(tblCarMap, list, [
    ["Vendedor","vendedor"],
    ["Qtd","count","right"],
    ["Clientes (√∫nicos)","_clients","right"],
    ["√öltimo","_last"]
  ], (row)=>({
    ...row,
    _clients: row.clients.size,
    _last: `${row.lastDate} ${row.lastTime||""}`.trim()
  }));
}

/* ---------- matrix daily tables ---------- */
function renderMatrixTable(tableEl, vendors, rows){
  const medias = ["Passante","Procura","Telefone"];

  // counts by vendor/media
  const counts = new Map(); // vendor -> {Passante:x,...}
  for(const v of vendors){
    counts.set(v, {Passante:0, Procura:0, Telefone:0});
  }
  for(const r of rows){
    const v = r.vendedor;
    const m = canonicalMidia(r.midia);
    if(!counts.has(v)) counts.set(v, {Passante:0, Procura:0, Telefone:0});
    if(medias.includes(m)) counts.get(v)[m]++;
  }

  const totalByMedia = {Passante:0, Procura:0, Telefone:0};

  let html = "";
  html += `<tr>
    <th>Vendedor</th>
    <th class="right">Passante</th>
    <th class="right">Procura</th>
    <th class="right">Telefone</th>
  </tr>`;

  for(const v of vendors){
    const c = counts.get(v) || {Passante:0, Procura:0, Telefone:0};
    totalByMedia.Passante += c.Passante;
    totalByMedia.Procura += c.Procura;
    totalByMedia.Telefone += c.Telefone;
    html += `<tr>
      <td><strong>${escapeHtml(v)}</strong></td>
      <td class="right">${c.Passante||0}</td>
      <td class="right">${c.Procura||0}</td>
      <td class="right">${c.Telefone||0}</td>
    </tr>`;
  }

  html += `<tr class="totalRow">
    <td><strong>TOTAL</strong></td>
    <td class="right">${totalByMedia.Passante}</td>
    <td class="right">${totalByMedia.Procura}</td>
    <td class="right">${totalByMedia.Telefone}</td>
  </tr>`;

  tableEl.innerHTML = html;
}

/* ---------- export daily report (canvas) ---------- */
async function exportDaily(mode){
  try{
    const iso = dailyDate.value || toISODate(new Date());
    const dayLabel = fromISOToBR(iso);

    // compute daily again for export
    const rows = state.cachedRows.filter(r => r._dateISO === iso);
    const vendors = state.vendors.slice();
    const blocks = {
      "NOVOS": rows.filter(r => canonicalTipo(r.tipoVenda)==="Vendas"),
      "SEMINOVOS": rows.filter(r => canonicalTipo(r.tipoVenda)==="Seminovos"),
      "VD": rows.filter(r => canonicalTipo(r.tipoVenda)==="Venda Direta"),
    };

    const sales = getSales(iso);

    // Canvas size (A4-ish landscape-ish) ‚Äî voc√™ pode ajustar
    const W = 1400;
    const H = 980;
    exportCanvas.width = W;
    exportCanvas.height = H;
    const ctx = exportCanvas.getContext("2d");

    // background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    // header band
    ctx.fillStyle = "#111";
    ctx.font = "bold 28px Arial";
    ctx.fillText("FLUXO DE ATENDIMENTO E VENDAS", 40, 54);
    ctx.font = "bold 18px Arial";
    ctx.fillStyle = "#333";
    ctx.fillText(`Relat√≥rio di√°rio ‚Äî ${dayLabel}${state.storeName ? " ‚Äî " + state.storeName : ""}`, 40, 86);

    // helper draw block table
    const drawBlock = (x,y,w,h,title,subtitle,color,rowsArr) => {
      // frame
      ctx.strokeStyle = "#111";
      ctx.lineWidth = 3;
      roundRect(ctx, x,y,w,h,14);
      ctx.stroke();

      // title bar
      ctx.fillStyle = color;
      roundRect(ctx, x, y, w, 54, 14);
      ctx.fill();
      ctx.strokeStyle = "#111";
      ctx.stroke();

      ctx.fillStyle = "#111";
      ctx.font = "bold 20px Arial";
      ctx.fillText(title, x + w/2 - ctx.measureText(title).width/2, y + 34);

      // subtitle bar (optional)
      if(subtitle){
        ctx.fillStyle = "#fff";
        ctx.fillRect(x, y+54, w, 44);
        ctx.strokeStyle="#111"; ctx.lineWidth=3;
        ctx.beginPath();
        ctx.moveTo(x, y+54); ctx.lineTo(x+w, y+54);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y+98); ctx.lineTo(x+w, y+98);
        ctx.stroke();

        ctx.fillStyle="#111";
        ctx.font="bold 18px Arial";
        ctx.fillText(subtitle, x + w/2 - ctx.measureText(subtitle).width/2, y+84);
      }

      const top = subtitle ? y+98 : y+54;
      const pad = 12;
      const tx = x + pad;
      let ty = top + 34;

      // columns
      const colV = Math.floor(w*0.40);
      const colW = Math.floor((w - colV - pad*2)/3);

      ctx.fillStyle="#f2f2f2";
      ctx.fillRect(x+3, top+3, w-6, 36);
      ctx.strokeStyle="#111"; ctx.lineWidth=2;
      ctx.strokeRect(x+3, top+3, w-6, 36);

      ctx.fillStyle="#111";
      ctx.font="bold 14px Arial";
      ctx.fillText("VENDEDOR", tx, top+27);
      ctx.fillText("PASSANTE", tx+colV+colW*0 + 10, top+27);
      ctx.fillText("PROCURA",  tx+colV+colW*1 + 10, top+27);
      ctx.fillText("TELEFONE", tx+colV+colW*2 + 10, top+27);

      // counts
      const counts = new Map();
      for(const v of vendors) counts.set(v, {Passante:0, Procura:0, Telefone:0});
      for(const r of rowsArr){
        const v = r.vendedor;
        const m = canonicalMidia(r.midia);
        if(!counts.has(v)) counts.set(v, {Passante:0, Procura:0, Telefone:0});
        if(counts.get(v)[m] !== undefined) counts.get(v)[m]++;
      }
      let tot = {Passante:0, Procura:0, Telefone:0};

      ctx.font="bold 16px Arial";
      const rowH = 34;
      let rowY = top + 36;

      for(const v of vendors){
        const c = counts.get(v);
        tot.Passante += c.Passante; tot.Procura += c.Procura; tot.Telefone += c.Telefone;

        ctx.fillStyle="#fff";
        ctx.fillRect(x+3, rowY+1, w-6, rowH);
        ctx.strokeStyle="#111"; ctx.lineWidth=1;
        ctx.strokeRect(x+3, rowY+1, w-6, rowH);

        ctx.fillStyle="#111";
        ctx.fillText(v, tx, rowY+24);
        ctx.textAlign="right";
        ctx.fillText(String(c.Passante), tx+colV+colW*0 + colW - 10, rowY+24);
        ctx.fillText(String(c.Procura),  tx+colV+colW*1 + colW - 10, rowY+24);
        ctx.fillText(String(c.Telefone), tx+colV+colW*2 + colW - 10, rowY+24);
        ctx.textAlign="left";

        rowY += rowH;
      }

      // total row
      ctx.fillStyle="#f6f6f6";
      ctx.fillRect(x+3, rowY+1, w-6, rowH);
      ctx.strokeStyle="#111"; ctx.lineWidth=2;
      ctx.strokeRect(x+3, rowY+1, w-6, rowH);
      ctx.fillStyle="#111";
      ctx.font="bold 16px Arial";
      ctx.fillText("TOTAL", tx, rowY+24);
      ctx.textAlign="right";
      ctx.fillText(String(tot.Passante), tx+colV+colW*0 + colW - 10, rowY+24);
      ctx.fillText(String(tot.Procura),  tx+colV+colW*1 + colW - 10, rowY+24);
      ctx.fillText(String(tot.Telefone), tx+colV+colW*2 + colW - 10, rowY+24);
      ctx.textAlign="left";

      return tot.Passante + tot.Procura + tot.Telefone;
    };

    // layout
    const leftX = 40, topY = 120, leftW = 920;
    const rightX = 1000, rightW = 360;

    const h1 = 260, hGap = 18;
    const novosFlux = drawBlock(leftX, topY, leftW, h1, "VENDAS / FLUXO", "NOVOS", "#ffe600", blocks.NOVOS);
    const semisFlux = drawBlock(leftX, topY + h1 + hGap, leftW, h1, "SEMINOVOS", "", "#89d46a", blocks.SEMINOVOS);
    const vdFlux    = drawBlock(leftX, topY + (h1 + hGap)*2, leftW, h1, "VD", "", "#b8c7ff", blocks.VD);

    // totals right
    const drawTotalBox = (x,y,w,title,color,value) => {
      ctx.strokeStyle="#111"; ctx.lineWidth=3;
      roundRect(ctx, x,y,w,170,14); ctx.stroke();
      ctx.fillStyle=color;
      roundRect(ctx, x,y,w,64,14); ctx.fill(); ctx.stroke();
      ctx.fillStyle="#111"; ctx.font="bold 16px Arial";
      const lines = title.split("\n");
      ctx.fillText(lines[0], x+w/2-ctx.measureText(lines[0]).width/2, y+26);
      ctx.fillText(lines[1], x+w/2-ctx.measureText(lines[1]).width/2, y+50);
      ctx.fillStyle="#fff"; ctx.fillRect(x+3, y+64, w-6, 106);
      ctx.strokeStyle="#111"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(x, y+64); ctx.lineTo(x+w, y+64); ctx.stroke();
      ctx.fillStyle="#111"; ctx.font="bold 64px Arial";
      const txt = String(value);
      ctx.fillText(txt, x+w/2-ctx.measureText(txt).width/2, y+142);
    };

    drawTotalBox(rightX, topY, rightW, "TOTAL DE FLUXO\nNOVOS", "#ffe600", novosFlux);
    drawTotalBox(rightX, topY + 188, rightW, "TOTAL DE FLUXO\nSEMINOVOS", "#89d46a", semisFlux);
    drawTotalBox(rightX, topY + 376, rightW, "TOTAL DE FLUXO\nVD", "#b8c7ff", vdFlux);

    // mini summary bottom
    const drawMini = (x,y,w,h,headColor,title,value,flux,conv) => {
      ctx.strokeStyle="#111"; ctx.lineWidth=3;
      roundRect(ctx,x,y,w,h,14); ctx.stroke();
      ctx.fillStyle=headColor;
      roundRect(ctx,x,y,w,72,14); ctx.fill(); ctx.stroke();
      ctx.fillStyle="#111"; ctx.font="bold 16px Arial";
      const t1 = title.split("\n");
      ctx.fillText(t1[0], x+w/2-ctx.measureText(t1[0]).width/2, y+28);
      ctx.fillText(t1[1], x+w/2-ctx.measureText(t1[1]).width/2, y+54);

      ctx.fillStyle="#fff"; ctx.fillRect(x+3,y+72,w-6,h-72-44);
      ctx.strokeStyle="#111"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(x,y+72); ctx.lineTo(x+w,y+72); ctx.stroke();

      ctx.fillStyle="#111"; ctx.font="bold 56px Arial";
      const v = String(value);
      ctx.fillText(v, x+w/2-ctx.measureText(v).width/2, y+148);

      ctx.fillStyle="#f3f3f3"; ctx.fillRect(x+3,y+h-44,w-6,41);
      ctx.strokeStyle="#111"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(x,y+h-44); ctx.lineTo(x+w,y+h-44); ctx.stroke();
      ctx.fillStyle="#111"; ctx.font="bold 16px Arial";
      const foot = `FLUXO DIA: ${flux} ¬∑ ${conv}`;
      ctx.fillText(foot, x+w/2-ctx.measureText(foot).width/2, y+h-16);
    };

    const miniY = 920;
    const miniW = 440;
    drawMini(40, miniY, miniW, 200, "#ffe600", "VENDAS / DIA\nNOVOS", sales.novos, novosFlux, pct(sales.novos, novosFlux));
    drawMini(40+miniW+20, miniY, miniW, 200, "#89d46a", "VENDAS / DIA\nSEMINOVOS", sales.semis, semisFlux, pct(sales.semis, semisFlux));
    drawMini(40+(miniW+20)*2, miniY, miniW, 200, "#b8c7ff", "VENDAS / DIA\nVD", sales.vd, vdFlux, pct(sales.vd, vdFlux));

    // expand canvas height to include minis
    // (recreate with correct size) ‚Äî simples: se miniY+h ultrapassar, refaz:
    const needH = miniY + 200 + 40;
    if(exportCanvas.height < needH){
      // refaz com altura maior (bem nerd, mas funciona)
      const data = exportCanvas.toDataURL("image/png");
      exportCanvas.height = needH;
      const ctx2 = exportCanvas.getContext("2d");
      await drawImageFromDataURL(ctx2, data, 0, 0);
      // desenha minis novamente (j√° est√£o no data, ent√£o n√£o precisa)
    }

    const blob = await new Promise(res => exportCanvas.toBlob(res, "image/png", 1));
    if(!blob) throw new Error("N√£o consegui gerar PNG");

    if(mode === "download"){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `relatorio_fluxo_${iso}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus("ok","relat√≥rio exportado", `üñºÔ∏è PNG gerado: <strong>relatorio_fluxo_${iso}.png</strong>`);
    }else if(mode === "copy"){
      if(!navigator.clipboard || !window.ClipboardItem){
        alert("Seu navegador n√£o permite copiar imagem diretamente. Use 'Baixar PNG'.");
        return;
      }
      await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
      setStatus("ok","imagem copiada", "üìã Relat√≥rio di√°rio copiado para a √°rea de transfer√™ncia.");
    }
  }catch(e){
    setStatus("bad","falha ao exportar", `Erro: <span class="mono small">${escapeHtml(String(e))}</span>`);
    alert("Falha ao exportar. Veja o status no topo.");
  }
}

/* ---------- settings ---------- */
function saveSettings(){
  try{
    state.webappUrl = resolveWebAppUrl(cfgUrl.value).toString();
    cfgUrl.value = state.webappUrl;
  }catch(e){
    setStatus("bad", "configura√ß√£o inv√°lida", `‚ö†Ô∏è <span class="mono small">${escapeHtml(String(e.message || e))}</span>`);
    return;
  }

  state.intervalSec = clampInt(cfgInterval.value, 15, 3600);
  state.storeName = (cfgStore.value || "").trim();
  saveState();
  reschedule();
  setStatus("ok","configura√ß√µes salvas", "‚úÖ Configura√ß√µes salvas em localStorage. Testando sincroniza√ß√£o...");
  syncNow(true);
}
function applyVendors(){
  const list = cfgVendors.value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(!list.length){ alert("Insira ao menos 1 vendedor."); return; }
  state.vendors = unique(list);
  // se order vazio, assume vendors
  if(!state.order || !state.order.length) state.order = state.vendors.slice();
  // garante que order s√≥ tenha nomes v√°lidos
  state.order = state.order.filter(v => state.vendors.includes(v));
  if(!state.order.length) state.order = state.vendors.slice();
  state.orderIndex = 0;
  saveState();
  refreshVendorsUI();
  renderOrder();
  renderAll();
  setStatus("ok","vendedores aplicados", "‚úÖ Lista de vendedores atualizada.");
}
function resetVendors(){
  if(!confirm("Resetar vendedores e ordem para o padr√£o?")) return;
  state.vendors = structuredClone(DEFAULTS.vendors);
  state.order = structuredClone(DEFAULTS.order);
  state.orderIndex = 0;
  cfgVendors.value = state.vendors.join("\n");
  cfgOrder.value = state.order.join("\n");
  saveState();
  refreshVendorsUI();
  renderOrder();
  renderAll();
  setStatus("ok","reset ok","‚úÖ Reset realizado.");
}
function shuffleOrder(){
  const base = (cfgOrder.value.trim() ? cfgOrder.value : cfgVendors.value).split("\n").map(s=>s.trim()).filter(Boolean);
  const valid = base.filter(v => state.vendors.includes(v));
  const shuffled = shuffle(valid.length ? valid : state.vendors.slice());
  cfgOrder.value = shuffled.join("\n");
}
function setOrderFromTextarea(){
  const list = cfgOrder.value.split("\n").map(s=>s.trim()).filter(Boolean);
  const valid = list.filter(v => state.vendors.includes(v));
  if(!valid.length){ alert("Ordem inv√°lida (vazia ou com nomes que n√£o existem na lista de vendedores)."); return; }
  state.order = valid;
  state.orderIndex = 0;
  saveState();
  renderOrder();
  setStatus("ok","ordem definida","‚úÖ Ordem de atendimento definida e salva.");
}
function clearCache(){
  if(!confirm("Limpar cache local de registros? (Os dados na planilha continuam.)")) return;
  state.cachedRows = [];
  state.cachedAt = 0;
  saveState();
  renderAll();
  setStatus("ok","cache limpo","üßΩ Cache local apagado. Recarregue com Atualizar.");
}

/* ---------- vendors UI ---------- */
function refreshVendorsUI(){
  // settings textarea
  cfgVendors.value = state.vendors.join("\n");
  cfgOrder.value = state.order.join("\n");

  // modal select + pickers
  fillSelect(fSeller, state.vendors, state.order[state.orderIndex] || state.vendors[0] || "");
  fillSelect(sellerPick, ["(selecione)"].concat(state.vendors), sellerPick.value || state.vendors[0] || "");
  if(sellerPick.value === "(selecione)") sellerPick.value = state.vendors[0] || "";
}
function refreshPickersFromData(rows){
  // cars from records
  const cars = unique(rows.map(r => (r.carro||"").trim()).filter(Boolean)).sort((a,b)=> a.localeCompare(b,"pt-BR"));
  fillSelect(carPick, cars.length? cars : ["(sem carros)"], carPick.value && cars.includes(carPick.value) ? carPick.value : (cars[0]||""));
  // seller pick stays based on vendors config
  refreshVendorsUI();
}

/* ---------- sales storage by date ---------- */
function getSales(iso){
  const obj = state.salesByDate[iso] || {novos:0, semis:0, vd:0};
  return {
    novos: clampInt(obj.novos||0,0,9999),
    semis: clampInt(obj.semis||0,0,9999),
    vd: clampInt(obj.vd||0,0,9999),
  };
}
function loadSalesForDay(){
  const iso = dailyDate.value || toISODate(new Date());
  const s = getSales(iso);
  salesNovos.value = s.novos;
  salesSemis.value = s.semis;
  salesVD.value = s.vd;
}
function saveSalesForDay(){
  const iso = dailyDate.value || toISODate(new Date());
  state.salesByDate[iso] = {
    novos: clampInt(salesNovos.value,0,9999),
    semis: clampInt(salesSemis.value,0,9999),
    vd: clampInt(salesVD.value,0,9999)
  };
  saveState();
  renderDaily(state.cachedRows || []);
}

/* ---------- utilities ---------- */
function normalizeRow(r){
  // aceita chaves vindas do Apps Script (com nomes exatos) e normaliza
  const dataBR = (r["Data"] ?? r.data ?? r.dataBR ?? "").toString().trim();
  const vendedor = (r["Vendedor"] ?? r.vendedor ?? "").toString().trim();
  const cliente = (r["Cliente"] ?? r.cliente ?? "").toString().trim();
  const carro = (r["Carro"] ?? r.carro ?? "").toString().trim();
  const tipoVenda = (r["Tipo de Venda"] ?? r.tipoVenda ?? r.tipo ?? "").toString().trim();
  const midia = (r["M√≠dia"] ?? r.midia ?? "").toString().trim();
  const hora = (r["Hor√°rio"] ?? r.hora ?? "").toString().trim();
  const telCliente = (r["Telefone do Cliente"] ?? r.telCliente ?? r.telefone ?? "").toString().trim();

  const iso = toISOFromBR(dataBR) || (r._dataISO || "");
  const ts = makeTS(iso, hora);

  return { dataBR, vendedor, cliente, carro, tipoVenda, midia, hora, telCliente, _dateISO: iso, _ts: ts };
}
function makeTS(iso, hhmm){
  if(!iso) return 0;
  const t = (hhmm || "00:00").trim();
  const m = t.match(/^(\d{1,2}):(\d{2})/);
  const H = m ? parseInt(m[1],10) : 0;
  const M = m ? parseInt(m[2],10) : 0;
  const d = new Date(iso+"T00:00:00");
  d.setHours(H,M,0,0);
  return d.getTime();
}
function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function toISOMonth(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function toTime(d){
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}
function fromISOToBR(iso){
  if(!iso) return "";
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return iso;
  return `${m[3]}/${m[2]}/${m[1]}`;
}
function toISOFromBR(br){
  const s = String(br||"").trim();
  if(!s) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return "";
  return `${m[3]}-${m[2]}-${m[1]}`;
}
function canonicalTipo(t){
  const s = String(t||"").trim().toLowerCase();
  if(s.includes("semin")) return "Seminovos";
  if(s.includes("diret")) return "Venda Direta";
  // default
  return "Vendas";
}
function canonicalMidia(m){
  const s = String(m||"").trim().toLowerCase();
  if(s.startsWith("pass")) return "Passante";
  if(s.startsWith("proc")) return "Procura";
  if(s.startsWith("tel")) return "Telefone";
  return "Procura";
}
function pct(a,b){
  if(!b) return "0%";
  const v = Math.round((a/b)*100);
  return `${v}%`;
}
function clampInt(v,min,max){
  const n = parseInt(v,10);
  if(Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}
function unique(arr){
  return Array.from(new Set(arr));
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function groupBy(arr, fn){
  const m = new Map();
  for(const it of arr){
    const k = fn(it);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(it);
  }
  return m;
}
function fillSelect(sel, options, value){
  sel.innerHTML = options.map(o => `<option value="${escapeAttr(o)}">${escapeHtml(o)}</option>`).join("");
  if(value && options.includes(value)) sel.value = value;
}
function renderTable(tableEl, rows, cols, mapFn){
  const safeRows = mapFn ? rows.map(mapFn) : rows;
  let html = "<tr>" + cols.map(([h]) => `<th>${escapeHtml(h)}</th>`).join("") + "</tr>";
  for(const r of safeRows){
    html += "<tr>" + cols.map(([_, key, cls]) => {
      const val = (r[key] ?? "").toString();
      return `<td class="${cls||""}">${escapeHtml(val)}</td>`;
    }).join("") + "</tr>";
  }
  tableEl.innerHTML = html;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return escapeHtml(s).replace(/"/g,"&quot;");
}

// rounded rectangle helper
function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function drawImageFromDataURL(ctx, dataURL, x, y){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{ ctx.drawImage(img, x, y); resolve(); };
    img.onerror = reject;
    img.src = dataURL;
  });
}
</script>
</body>
</html>
